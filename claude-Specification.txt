#この仕様書には絵文字は使用しないでください


● 事業者管理アプリ - 最新版仕様書

  プロジェクト概要

  Supabase + Vercel サーバーレス完全移行版事業者管理アプリケーション

- 本番URL: https://mori-jigyosya.vercel.app/
- Supabase Project: https://ocfljsoxxgmnzqlquchx.supabase.co
- リポジトリ: 

  技術スタック

  フロントエンド

  - HTML/CSS/JavaScript (Vanilla)
  - ホスティング: Vercel (サーバーレス)
  - 認証: Google OAuth 2.0
  - UI: カスタムドロップダウン、アコーディオンメニュー、モダントースト通知、テーブルリサイズ

  バックエンド・データベース

  - データベース: Supabase PostgreSQL
  - 認証: Supabase Auth (Google OAuth連携)
  - API: Supabase REST API + Edge Functions
  - 自動化: pg_cron拡張による定期処理
  - リアルタイム: Supabaseリアルタイム機能

  データベース構造

1. app_links

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
name
varchar
NOT NULL
url
text
NOT NULL
display_order
integer
DEFAULT 0
created_at
timestamp
DEFAULT now()

2. backup_history

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
backup_date
timestamp
backup_type
varchar
status
varchar
file_name
varchar
file_size_kb
integer
total_records
integer
error_message
text
created_at
timestamp
DEFAULT now()

3. clients

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
name
varchar
NOT NULL
fiscal_month
integer
CHECK (1–12)
staff_id
integer
FK → staffs.id
accounting_method
varchar
DEFAULT '記帳代行'
status
varchar
DEFAULT 'active'
custom_tasks_by_year
jsonb
DEFAULT '{}'
finalized_years
jsonb
DEFAULT '[]'
overall_memo
text
DEFAULT ''
created_at
timestamp
DEFAULT now()
updated_at
timestamp
DEFAULT now()

4. default_tasks

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
task_name
varchar
accounting_method
varchar
tasks
jsonb
display_order
integer
DEFAULT 0
is_active
boolean
DEFAULT true
created_at
timestamp
DEFAULT now()
updated_at
timestamp
DEFAULT now()

5. editing_sessions

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
client_id
integer
FK → clients.id
user_id
varchar
NOT NULL
started_at
timestamp
DEFAULT now()
last_activity
timestamp
DEFAULT now()

6. monthly_tasks

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
client_id
integer
FK → clients.id
month
varchar
NOT NULL
tasks
jsonb
DEFAULT '{}'
status
varchar
DEFAULT 'pending'
url
text
memo
text
created_at
timestamp
DEFAULT now()
updated_at
timestamp
DEFAULT now()
task_memos
jsonb
DEFAULT '{}'
completed
boolean
NOT NULL, DEFAULT false

7. settings

Column
Type
Constraints / Default
Keys
key
varchar
NOT NULL
PK
value
jsonb
NOT NULL
created_at
timestamp
DEFAULT now()
updated_at
timestamp
DEFAULT now()

8. staffs

Column
Type
Constraints / Default
Keys
id
integer
NOT NULL, DEFAULT nextval
PK
name
varchar
NOT NULL
email
varchar
role
varchar
DEFAULT 'staff'
created_at
timestamp
DEFAULT now()
updated_at
timestamp
DEFAULT now()

Relationships (Foreign Keys)
clients.staff_id → staffs.id
editing_sessions.client_id → clients.id
monthly_tasks.client_id → clients.id


  認証・セキュリティ

  Google OAuth認証

  - 認証プロバイダー: Google OAuth 2.0
- 承認済みオリジン: https://mori-jigyosya.vercel.app
  - セッション管理: Supabase Auth自動管理
  - ログイン頻度: 1日1回認証（自動セッション管理）

  Row Level Security (RLS) - 実装完了
  - データアクセス制御: Supabase RLS
  - 認証必須: 未ログイン時はデータアクセス不可
  - Anon Key: 公開（フロントエンド用、RLSで保護）

  主要機能

  1. クライアント管理

  - 一覧表示: 担当者別フィルター、検索機能
  - CRUD操作: 追加、編集、削除、再有効化
  - 関与終了機能: 業務終了クライアントのステータス管理
    ├── グレーアウト表示: 設定により非表示/グレー表示切替
    ├── 復活機能: 関与終了状態からの復帰
    └── 管理者権限削除: 物理削除は管理者のみ実行可能
  - カスタムタスク設定: クライアント独自の項目設定
  - 年度確定機能: 特定年度のタスク項目ロック
  - 全体メモ機能: クライアント全体に関するメモ記録・保存

  1.5. 担当者管理機能

  - CRUD操作: 担当者の追加・編集・削除（削除制限機能付き）
  - 割り当て管理: 担当クライアント数の自動集計・表示
  - 削除制限: 担当クライアントが存在する場合の削除防止機能
  - CSV抽出機能: 担当者情報の完全エクスポート
    ├── 出力項目: ID、担当者名、メール、権限、担当クライアント数、担当先一覧、作成・更新日時
    ├── 権限日本語化: admin→管理者、staff→担当者の自動変換
    ├── Excel対応: BOM付きUTF-8エンコーディング
    └── 担当先一覧: セミコロン区切りでの複数クライアント名表示
  - UI最適化: モーダルサイズ調整（700px幅、85vh高さ制限）

  2. 月次進捗管理

  - 進捗入力: チェックボックス形式
  - ステータス表示: `completed`フラグに基づき、最後に完了した年月を表示
  - 自動完了機能: 詳細画面でタスクを100%にして保存すると、自動で`completed`フラグが更新され、10種類の達成時エフェクトからランダムに1つが再生される
  - URL・メモ: 各月次記録に付加情報

  3. タスク項目管理

  - デフォルトタスク: 全クライアント共通の初期項目
  - カスタムタスク: クライアント別独自項目
  - 年度継承: 新年度アクセス時の前年度項目継承
  - タスク伝播: 項目変更時の未確定年度への反映

  4. 年度確定システム

  - 確定機能: 特定年度のタスク項目をロック
  - 編集制限: 確定済み年度は編集不可
  - 継承制御: 確定済み項目の新年度継承

  5. データ管理

  - **自動バックアップシステム**: Supabase Edge Functions + Cron Job による24時間365日自動実行
    ├── 毎日0:00（JST）自動実行: pg_cron スケジューラによる確実な実行
    ├── 週次ローテーション: Sunday-Saturday フォルダでストレージ最適化
    ├── クラウドストレージ: Supabase Storage による安全な保管
    ├── 実行履歴管理: backup_history テーブルでの監視・トラッキング
    └── 緊急時手動実行: アプリUI からの即座バックアップ機能
  - **手動バックアップシステム**: JSON形式・週次ローテーション・File System Access API対応
  - **安全な復元機能**: 外部キー制約・データ整合性完全保証
  - CSVエクスポート: UTF-8 BOM付きExcel対応
  - CSVインポート: 複数エンコーディング対応
  - データベース初期化: 完全リセット機能

  6. 編集制御

  - 悲観ロック: 編集競合防止
  - 強制解除: 編集セッション強制終了
  - 自動タイムアウト: 一定時間後の自動解除

  7. UI/UX改善機能

  - モダントースト通知システム
  - テーブル列幅調整システム

  8. その他アプリ連携機能

  - リンク管理: モーダル画面でのURLリンク管理（名称・URL）
  - CRUD操作: 追加・削除・保存に対応
  - 表示順変更: ドラッグ＆ドロップによる並べ替え
  - 動的ボタン生成: メイン画面のアコーディオン内に、登録したリンクをボタンとして動的生成
  - 外部リンク遷移: ボタンクリックで設定したURLを新しいタブで開く

  9. 高度分析機能付き進捗管理ダッシュボード

  **フェーズ1: 進捗管理ダッシュボード** - 実装完了
  - **多条件フィルター**: 期間・担当者・決算月での絞り込み
  - **動的サマリー**: 全体進捗率・完了タスク数・要注意クライアント自動検出
  - **進捗マトリクス表**: 事業者×年月のマトリクス表示
  - **完全ソート機能**: 事業者名・進捗率・担当者・決算月・月別進捗での並び替え
  - **月別進捗列**: 選択期間に応じた動的列生成
  - **カラーコード表示**: 緑（80%以上）/黄（50-79%）/赤（50%未満）
  - **エクスポート機能**: CSV・Excel（3種類）・PDF形式での出力
    ├── Excel統合シート: サマリーと進捗マトリクスを1シートに統合
    ├── Excel進捗表示: 基本・ヘッダー強調・アイコン付きの3形式
    └── PDF横向き出力: 月次データの色分け表示対応

  **フェーズ2: 担当者別パフォーマンスダッシュボード** - 実装完了
  - **パフォーマンス指標**: 担当クライアント数・平均完了率・完了月数・遅延発生月数
  - **4段階評価システム**: 優秀（95%以上）/良好（85-94%）/標準（70-84%）/要改善（70%未満）
  - **柔軟期間設定**: 今年度・前四半期・6ヶ月・12ヶ月・カスタム期間対応
  - **完全ソート機能**: 全パフォーマンス指標でのソート対応
  - **詳細確認連携**: ワンクリックで進捗ダッシュボードへ遷移
  - **相互ナビゲーション**: 進捗⟷パフォーマンスダッシュボード間の移動

  ユーザーインターフェース

  メイン画面

  - 検索バー: 事業所名・担当者名での絞り込み
  - フィルター: 担当者別、月別、ステータス別
  - 一覧表示: デスクトップはテーブル形式、モバイルはカード形式で自動切替
  - **固定テーブルヘッダー**: スクロール時でも常時表示・項目確認が容易
  - **分析機能ボタン**: 独立配置で全員がアクセス可能
  - アコーディオンメニュー: 「管理メニュー」と「その他アプリ」の2種類を配置
  - テーブル列幅調整: ドラッグ&ドロップで列幅をカスタマイズ
  - トースト通知: 右下からの優雅な通知システム
  - レスポンシブ対応: 480px以下でモバイル専用UI に自動変換

  管理メニュー

  - 管理メニュー
    ├── 担当者管理（CSV抽出機能付き）
    ├── 顧問先追加
    ├── 基本設定
    ├── 項目の初期値の設定
    ├── バックアップ設定
    ├── CSVエクスポート
    ├── CSVインポート
    ├── 列幅リセット
    └── データベース初期化
  - その他アプリ
    ├── URL設定
    └── (動的に生成されるURLリンクボタン)

  詳細画面アコーディオン

  - データ管理メニュー
    ├── この年度の項目を確定
    ├── 項目を翌期以降に再反映
    ├── 削除された項目を自動削除
    ├── データ整合性チェック
    └── 項目の変更

  **分析機能画面**

  - **進捗管理ダッシュボード**: analytics.html
    ├── フィルター & アクションエリア: 多条件絞り込み
    ├── 動的サマリーダッシュボード: リアルタイム集計結果
    ├── 進捗マトリクス表: 事業者×年月のマトリクス
    └── 完全ソート機能: 全列でのソート対応

  - **担当者別パフォーマンスダッシュボード**: performance.html
    ├── 期間設定エリア: 柔軟な期間選択
    ├── パフォーマンス一覧表: 担当者別指標表示
    ├── 4段階評価システム: 視覚的パフォーマンス評価
    └── 詳細確認連携: 進捗ダッシュボードへの遷移

  詳細・編集画面

  - 月次進捗表: 12ヶ月分の進捗管理
  - カスタムタスク設定: ドラッグ&ドロップ対応
  - 年度確定ボタン: 動的表示制御
  - 編集ロック表示: 編集中ユーザーの表示
  - ステータス管理UI
  - モバイル最適化: 横画面推奨表示、固定要素無効化、タッチフレンドリーUI

  設定・カスタマイズ

  環境設定

  // Supabase設定（自動検出）
  const SUPABASE_URL = 'https://lqwjmlkkdddjnnxnlyfz.supabase.co'
  const SUPABASE_ANON_KEY = '[自動設定]'

  カスタマイズ可能項目

  - デフォルトタスク項目: 基本設定から変更可能
  - 担当者リスト: 動的追加・編集
  - 年度設定: 会計年度に応じた自動調整
  - UI色調: CSS変数での一括変更
  - 外部リンク: 「その他アプリ」メニューから自由に設定可能

  パフォーマンス

  - CDN配信: Vercel Edge Network, jsDelivr (SortableJS)

  (その他変更なし)

  最新の進捗（2025年9月15日更新）

#### 今回セッション（9/15）- UI/UX改善 & PDF最適化 & 進捗表示機能強化

1. **詳細画面JavaScript修正** - 完了
   - **変数名不一致修正**: `generalMemoField` → `generalMemoFieldField` で変数名統一
   - **URL自動リンク化エラー解決**: initializeAutoLinkify関数のReferenceError修正
   - **構文チェック**: JavaScriptエラーの完全解消

2. **担当者別パフォーマンス一覧機能改善** - 完了
   - **フィルタリング機能**: 担当クライアント数が0の担当者を非表示化
   - **表示最適化**: アクティブな担当者のみを一覧表示
   - **3つの関数修正**: displayPerformanceResults, sortTable, displaySortedResults

3. **進捗マトリクス表の視覚的改善** - 完了
   - **資料受付完了表示**: 分子が1の場合に📋アイコンを自動表示
   - **2箇所での実装**: メイン表示関数とPDF印刷用関数の両方に対応
   - **直感的UI**: 1/5 → 📋 1/5 で資料受付状況を一目で把握可能

4. **PDFエクスポート機能の大幅改善** - 完了
   - **ダッシュボード準拠デザイン**: 現在の画面と同じ見た目でPDF生成
   - **横向きレイアウト**: A4 landscape形式での最適化
   - **情報密度向上**: ヘッダー情報を1行に集約、サマリーを枠なし表示
   - **決算月表示**: サイトと同様の赤線表示（📅アイコン削除）
   - **年月列幅統一**: 50px固定で整列表示
   - **行高最適化**: セルパディング縮小（6px→2px）で情報量最大化

5. **週次進捗グラフ機能の設計** - 計画完了
   - **実装計画書作成**: 7ステップの詳細手順書を作成
   - **データベース設計**: weekly_progress_snapshots テーブル仕様策定
   - **フィルター連動**: 既存フィルター条件に完全対応
   - **Chart.js実装**: 折れ線グラフによる週次推移表示
   - **総所要時間**: 約2時間15分の実装予定



#### 次回以降の実装予定（優先順位順）

1. **週次進捗グラフ機能実装**【次回最優先】
   - weekly_progress_snapshotsテーブル作成
   - Chart.jsによる週次推移折れ線グラフ
   - フィルター条件連動（担当者・決算月・期間・事業者名）
   - スナップショット保存機能（手動・将来的に自動）
   - 前週比増減値表示機能

2. **悲観ロック機能の修復**
   - 編集競合防止システムの改善
   - 強制解除機能の最適化
   - タイムアウト処理の調整

3. **通知システム実装**
   - 期限接近アラート
   - 完了通知
   - システム更新通知

4. **詳細レポート機能**
   - 月次・年次レポート生成
   - PDF出力機能
   - カスタマイズ可能なレポートテンプレート

5. **高度検索機能**
   - 複合条件検索
   - 保存済み検索条件
   - 検索履歴管理

6. **パフォーマンス最適化**
   - 大量データ処理の高速化
   - キャッシュ戦略の改善
   - 遅延読み込み（Lazy Loading）の実装

#### 現在の完成度
- **基本機能**: 100%完成（全体メモ機能追加）
- **担当者管理機能**: 100%完成（CSV抽出機能・UI最適化完了）
- **データ整合性チェック**: 100%完成（決算月対応・JSONパース修正完了）
- **自動バックアップシステム**: 100%完成（Supabase Edge Functions + Cron Job）
- **手動バックアップ・復元**: 100%完成
- **UI/UX**: 100%完成（PDFエクスポート最適化・進捗表示改善完了）
- **モバイル対応**: 100%完成
- **データ管理**: 100%完成（自動バックアップシステム完全対応）
- **分析機能**: 100%完成（担当者フィルタリング・進捗表示改善完了）
- **エクスポート機能**: 100%完成（PDF最適化・ダッシュボード準拠デザイン完了）
- **カスタマイズ機能**: 100%完成（個人設定対応）
- **グラフ機能**: 30%完成（基本円グラフ実装済み・週次グラフ設計完了）
- **通知システム**: 0%（未実装）
- **高度機能**: 100%完成（進捗マトリクス視覚改善により完成）

(以下、変更なし)

## 次回セッションでの実装予定作業事項（2025年9月13日記録）

### **実装準備完了の機能（手順書あり）**

1. **スマートデバウンス自動保存機能の実装**
   - **対象画面**: 詳細画面（details.html）
   - **実装方式**: 3秒デバウンス + AutoSaveManagerクラス
   - **準備状況**: 完全な実装手順書（claude-autosave-implementation.txt）
   - **実装時間**: 約2.5時間（テスト含む）

2. **進捗管理ダッシュボードのメイン画面化**
   - **移設対象**: analytics.html → 新メイン画面
   - **移植機能**: 編集ボタン、管理メニュー、設定メニュー
   - **実装方式**: ファイル名変更方式（推奨）またはリダイレクト方式
   - **準備状況**: 詳細計画書（claude-change-to-main.txt）


---

## 開発時の注意
①commit分は短く英文で作成してください
②開発はステップバイステップで進めて下さい  
③良いアイデアがあったら教えてください
④**安定性を最優先**とし、問題発生時は即座にロールバックを実行してください

共有用完成
